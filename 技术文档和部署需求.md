# DeepSeekQ 技术文档和部署需求

**项目概述**
- 这是一个基于 `DeepSeek` 大模型与 `ccxt` 交易所接口的自动交易机器人项目，支持 Binance 期货与 OKX 永续合约。
- 通过获取 K线数据、计算技术指标、融合市场情绪（可选），再由 DeepSeek 模型输出 JSON 化交易信号，最终以市价单执行交易。
- 提供多种策略脚本版本：基础版（Binance）、OKX版、技术指标增强版、市场情绪+技术指标版。

**代码结构**
- `deepseek.py`：Binance 期货基础版本，含定时执行、DeepSeek信号、下单逻辑。
- `deepseek_ok版本.py`：OKX 版本，单向持仓、全仓模式，按周期定时运行。
- `deepseek_ok_带指标plus版本.py`：OKX 技术指标增强版，计算 MA/EMA/MACD/RSI/布林带与支撑阻力，强化提示词与下单标签。
- `deepseek_ok_带市场情绪+指标版本.py`：在指标增强的基础上增加市场情绪数据，含智能仓位管理与更严谨的执行细节。
- `requirements.txt`：Python 依赖清单。
- `README.md`：简易部署提示与环境准备（建议结合本文件进行修订）。

**工作流程**
- 数据获取：用 `ccxt` 的 `fetch_ohlcv` 拉取 `BTC/USDT` 或 `BTC/USDT:USDT` 的指定 `timeframe` K线数据。
- 技术指标：计算 `SMA/EMA/MACD/RSI/布林带`、成交量均线与简易支撑/阻力等指标（增强版脚本）。
- 情绪数据：在“市场情绪+指标版”中，调用 `https://service.cryptoracle.network/openapi/v2/endpoint` 获取正负面比率与净值，并考虑数据延迟。
- 策略分析：构造包含近期K线、技术指标、持仓信息（和情绪文本）的提示词，调用 `https://api.deepseek.com`，解析返回的 JSON 信号（`BUY | SELL | HOLD`，含 `stop_loss/take_profit/confidence`）。
- 交易执行：依据信号与当前持仓，以市价单在 OKX 或 Binance 执行开仓、平仓或调整仓位；OKX 使用 `reduceOnly` 控制平仓、`tag` 标记订单。
- 调度运行：基础版使用 `schedule` 按 `15m/1h` 周期调度；增强与情绪版按“每15分钟整点”循环触发执行。

**配置与密钥**
- 需在项目根目录创建 `.env` 文件，示例：
  - `DEEPSEEK_API_KEY=<你的deepseek api密钥>`
  - `BINANCE_API_KEY=<你的binance api key>`
  - `BINANCE_SECRET=<你的binance api secret>`
  - `OKX_API_KEY=<你的okx api key>`
  - `OKX_SECRET=<你的okx api secret>`
  - `OKX_PASSWORD=<你的okx交易密码>`
- 市场情绪数据的 `Cryptoracle API Key` 目前硬编码在 `deepseek_ok_带市场情绪+指标版本.py` 中，建议改为 `.env` 管理，例如：
  - `CRYPTORACLE_API_KEY=<你的cryptoracle api key>`
- 交易对与周期：
  - Binance 使用 `symbol='BTC/USDT'`，期货模式 `options={'defaultType': 'future'}`。
  - OKX 使用 `symbol='BTC/USDT:USDT'`，永续合约模式 `options={'defaultType': 'swap'}`。
  - 周期主要为 `15m`，可切到 `1h`（基础版提供调度分支）。
- 杠杆与持仓：
  - OKX 脚本设定 `mgnMode='cross'`（全仓），可按需改为逐仓。
  - Binance 基础版直接 `set_leverage` 到交易对。

**依赖与运行环境**
- Python 版本：建议 `3.10`（与 README 保持一致；注意其中 `python=4.10` 为笔误）。
- 依赖包：`ccxt`、`openai`、`pandas`、`schedule`、`python-dotenv`、`requests`、`urllib3`。
- 网络要求：
  - 访问 `https://api.deepseek.com`（DeepSeek）与对应交易所 API（OKX/Binance）。
  - 使用情绪版需访问 `https://service.cryptoracle.network/openapi/v2/endpoint`。
  - 服务器时间与时区建议统一为 UTC，保证整点逻辑一致。

**运行方式**
- 初次准备：
  - 创建并激活虚拟环境：`python -m venv .venv && .\.venv\Scripts\activate`（Windows）或 `python -m venv .venv && source .venv/bin/activate`（Linux/macOS）。
  - 安装依赖：`pip install -r requirements.txt`。
  - 在根目录创建 `.env` 并填入密钥。
- 启动脚本（示例）：
  - Binance 基础版：`python deepseek.py`
  - OKX 基础版：`python deepseek_ok版本.py`
  - OKX 指标增强版：`python deepseek_ok_带指标plus版本.py`
  - OKX 情绪+指标版：`python deepseek_ok_带市场情绪+指标版本.py`
- 建议先将 `TRADE_CONFIG['test_mode'] = True`，确认流程无误后再切换到实盘。

**策略版本要点**
- `deepseek.py`
  - 交易所：Binance 期货。
  - 调度：`schedule` 每 15 分钟或每小时执行；下单使用 `create_market_buy/sell_order`。
- `deepseek_ok版本.py`
  - 交易所：OKX 永续；全仓模式；单向持仓。
  - 下单：`create_market_order`，平仓时用 `reduceOnly: True`，含订单 `tag` 用于标识。
- `deepseek_ok_带指标plus版本.py`
  - 技术指标：MA/EMA/MACD/RSI/布林带、成交量均线与支撑阻力；趋势判断 `强势上涨/下跌/震荡整理`。
  - 运行机制：自循环等待 15 分钟整点执行；更完整的持仓与订单处理。
- `deepseek_ok_带市场情绪+指标版本.py`
  - 情绪数据：正负面比率与净值，打印延迟；与技术分析融合并设定权重与规则。
  - 智能仓位：依据账户余额、信心等级与趋势强度计算目标合约张数（含上限与RSI修正）。
  - 执行细节：同向加/减仓、反向平仓后开新仓、`reduceOnly` 控制、异常分支兜底开仓。

**交易执行细节**
- 市价单：以 `create_market_order`（OKX）或 `create_market_buy/sell_order`（Binance）执行。
- 订单标签：OKX 中 `params={'tag': '...'}'`；可自定义，便于后续审计与统计。
- 平仓与持仓调整：
  - 平仓统一加 `reduceOnly: True`，避免误加仓。
  - 已持仓同向信号时按差值加/减仓，容忍阈值避免频繁微调。
- 风险控制：
  - 低信心信号可直接跳过（情绪版已实现）。
  - DeepSeek 返回 JSON 中包含 `stop_loss/take_profit`，建议在后续版本落地为实际止盈止损单。

**部署需求**
- 操作系统：
  - Linux（Ubuntu 20.04+）推荐；Windows 10/11 可运行但请关注计划任务与后台守护。
- 资源建议：
  - CPU/RAM 一般性（1 vCPU/2GB 即可）；磁盘空间 1GB+。
- Python 环境：
  - 使用 `3.10`，虚拟环境或 Conda 均可。示例（Conda）：
    - `conda create -n ds python=3.10`
    - `conda activate ds`
    - `pip install -r requirements.txt`
- 网络放行：
  - 出站访问 `api.deepseek.com`、交易所 API 域名、`service.cryptoracle.network`。
  - NTP 时间同步，确保 15 分钟整点逻辑准确。
- 账户与权限：
  - 交易所 API key 需开启交易权限；OKX 需提供 `password`；注意 IP 白名单与风控限制。
- 后台守护：
  - Linux 推荐 `pm2` 或 `systemd`；示例：`pm2 start "python deepseek_ok_带市场情绪+指标版本.py" --name deepseek-ok`。
  - Windows 可用计划任务 `schtasks` 或 `nssm` 注册为服务进程。

**运维与监控**
- 日志：当前仅 `print`；建议后续接入标准日志库、区分 INFO/ERROR 并做日志轮转。
- 健康检查：可每次轮询打印账户余额、持仓与上次信号；异常时告警（邮件/钉钉/飞书）。
- 审计追踪：建议保留订单 `tag` 与信号历史 `signal_history`，落库或写文件便于回溯。

**常见问题与建议**
- `.env` 未加载：确认 `.env` 位于项目根目录，且运行路径正确；脚本均调用 `load_dotenv()`。
- 情绪 API Key：当前在代码中硬编码，务必改为 `.env` 并在脚本中读取。
- README 中 `python=4.10` 为笔误，应使用 `python=3.10`。
- 先用 `test_mode=True` 验证全流程；切到实盘前检查 `set_leverage/mgnMode` 与持仓模式一致性。
- 交易对与最小张数：OKX 脚本会读取合约 `contractSize` 与 `min_amount`，下单前请确认限制与最小单位。

**快速启动清单**
- 创建 `.env` 并填入 `DEEPSEEK/交易所` 密钥。
- `pip install -r requirements.txt` 安装依赖。
- 将脚本中的 `TRADE_CONFIG['test_mode']` 设为 `True` 并运行一个版本验证数据流。
- 验证持仓读取、信号解析与订单执行路径（模拟模式不下单）。
- 切回 `False` 启动实盘，并启用后台守护进程。

**Roadmap（可选优化）**
- 将 `Cryptoracle API Key` 读取改造为 `.env`，并统一配置管理。
- 接入真实止盈止损与风控限价单；支持双向持仓或逐仓模式切换。
- 增加日志与告警、回测模块与绩效评估报表。
- 整理 Dockerfile 与 Compose，以便快速容器化部署。