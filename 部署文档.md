# 部署文档

**推荐方案**
- 推荐使用 Docker Compose 运行（稳定、可复现、便于守护与日志管理）。
- 初次上线建议选择脚本 `deepseek_ok_带指标plus版本.py`（只依赖技术指标，减少外部情绪源的不可控因素）。稳定后可切换到 `deepseek_ok_带市场情绪+指标版本.py`（需额外情绪接口密钥）。

---

## 一、环境要求
- **CPU**: 2核
- **内存**: 2GB
- **存储**: 40GB SSD
- 操作系统：Ubuntu Server 24.04 LTS（已满足）
- 已安装：Docker 27.5.1（已满足）
- 可选：`docker compose` 插件（若无会在步骤中安装）
- 代码仓库：`https://github.com/Behait/DeepSeekQ.git`

## 二、获取代码
```bash
sudo mkdir -p /opt && cd /opt
sudo apt update && sudo apt install -y git
sudo git clone https://github.com/Behait/DeepSeekQ.git
sudo chown -R $USER:$USER /opt/DeepSeekQ
cd /opt/DeepSeekQ
```

## 三、配置密钥与环境变量
在项目根目录创建 `.env`（不提交到版本库）：
```env
DEEPSEEK_API_KEY=你的deepseek_api密钥
BINANCE_API_KEY=你的binance_api_key
BINANCE_SECRET=你的binance_api_secret
OKX_API_KEY=你的okx_api_key
OKX_SECRET=你的okx_api_secret
OKX_PASSWORD=你的okx交易密码
# 如使用“市场情绪+指标版”，建议加入：
CRYPTORACLE_API_KEY=你的cryptoracle_api_key
```
注意：当前情绪脚本 `deepseek_ok_带市场情绪+指标版本.py` 中 `API_KEY` 为硬编码，后续建议改为 `os.getenv('CRYPTORACLE_API_KEY')` 读取（不影响先按指标版运行）。

## 四、Docker Compose 部署
在项目根目录创建 `docker-compose.yml`：
```yaml
services:
  bot:
    image: python:3.12-slim
    working_dir: /app
    volumes:
      - ./:/app
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=UTC
    # 首次建议运行指标版脚本
    command: bash -lc "pip install --no-cache-dir -r requirements.txt && sed -i 's/\"test_mode\": False/\"test_mode\": True/g' deepseek_ok_带指标plus版本.py && python deepseek_ok_带指标plus版本.py"
    restart: unless-stopped
```
说明：
- `PYTHONUNBUFFERED=1` 让日志实时输出；`TZ=UTC` 保证 15 分钟整点逻辑一致。
- `command` 中临时将 `test_mode` 打开，验证无误后再改为 `False`。
- 若需切换脚本，将 `python deepseek_ok_带指标plus版本.py` 替换为目标脚本。

安装 compose 插件并启动：
```bash
sudo apt install -y docker-compose-plugin  # 若已安装可跳过
docker compose up -d
```
查看日志：
```bash
docker compose logs -f
```

切换到实盘：
- 编辑 `docker-compose.yml` 的 `command` 去掉 `sed` 修改，将脚本中的 `TRADE_CONFIG['test_mode']` 改为 `False`。
- 重新启动：
```bash
docker compose up -d
```

更新代码：
```bash
cd /opt/DeepSeekQ
git pull
docker compose up -d
```

重启与停止：
```bash
docker compose restart
# 或
docker compose down   # 停止并移除容器
```

## 五、脚本选择建议
- 首次运行：`deepseek_ok_带指标plus版本.py`（技术指标充分，稳定性较好）。
- 需要更智能的仓位与情绪：`deepseek_ok_带市场情绪+指标版本.py`（需 `CRYPTORACLE_API_KEY`）。
- 使用 Binance：`deepseek.py`（期货，注意设置密钥与交易权限）。

## 六、时间与时区
- 脚本存在“每 15 分钟整点”逻辑，建议统一使用 UTC：
```bash
sudo timedatectl set-timezone UTC
``` 
- Compose 已设置 `TZ=UTC`，宿主机和容器时间保持一致更稳妥。

## 七、原生 Python（备选）
如不使用 Docker，可按以下步骤：
```bash
sudo apt update && sudo apt install -y python3-venv
cd /opt/DeepSeekQ
python3 -m venv .venv
source .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
# 首次测试运行（指标版）
sed -i "s/\"test_mode\": False/\"test_mode\": True/g" deepseek_ok_带指标plus版本.py
python deepseek_ok_带指标plus版本.py
```
后台守护（systemd）：
```ini
# /etc/systemd/system/deepseek.service
[Unit]
Description=DeepSeekQ Trading Bot
After=network.target

[Service]
WorkingDirectory=/opt/DeepSeekQ
ExecStart=/opt/DeepSeekQ/.venv/bin/python /opt/DeepSeekQ/deepseek_ok_带指标plus版本.py
Restart=always
RestartSec=10
EnvironmentFile=/opt/DeepSeekQ/.env

[Install]
WantedBy=multi-user.target
```
启用与查看：
```bash
sudo systemctl daemon-reload
sudo systemctl enable deepseek
sudo systemctl start deepseek
sudo systemctl status deepseek
journalctl -u deepseek -f
```

## 八、验证与健康检查
- 首次务必在 `test_mode=True` 下观察输出：
  - DeepSeek 返回的 JSON 是否被成功解析；
  - `fetch_positions` 是否能正常读取持仓；
  - 指标版是否打印技术指标与趋势判断；
  - OKX 合约 `contractSize` 与最小张数是否打印。
- 一切正常后再切到 `False`。

## 九、风险与安全建议
- API 密钥：开启只读/交易权限的最小必要授权；OKX 配置 IP 白名单；避免泄露日志。
- 风控：当前为市价单执行；`stop_loss/take_profit` 来自模型建议，尚未落地为真实条件单，实盘前明确你的风险策略。
- 资金与杠杆：谨慎设置 `leverage` 与仓位；建议从小额实盘开始。

## 十、故障排查
- DeepSeek 连接失败：检查 `DEEPSEEK_API_KEY` 与网络出站访问；重试。
- JSON 解析失败：模型可能返回了非纯 JSON，脚本已做安全截取；持续失败考虑调低调用频率或优化提示词。
- 交易所 API 报错：检查密钥权限、持仓模式（全仓/逐仓）、最小张数限制与 `reduceOnly` 参数。
- 情绪数据为空或延迟大：先使用指标版；情绪版确认 `CRYPTORACLE_API_KEY` 正确并网络可达。

---

## 快速步骤（Compose）
```bash
cd /opt/DeepSeekQ
nano .env                 # 写入密钥
nano docker-compose.yml   # 粘贴上文模板
docker compose up -d      # 启动（默认 test_mode=True）
docker compose logs -f    # 观察日志
# 验证通过后，切到实盘：编辑脚本 test_mode=False，再 up -d
```

=====================================================
服务器运行建议
docker exec -it deepseek-trading-bot bash
# 手动运行脚本看详细错误
python3 deepseek_ok_带指标plus版本.py
----------------------------------------
# 编辑 docker-compose.yml
nano docker-compose.yml

# 将 command 改为：
command: python deepseek_ok版本.py

# 重启
docker compose up -d

====================================================
本地运行建议

- 方式一（推荐）：先激活虚拟环境，再运行脚本
  - venv\Scripts\Activate.ps1
  - python .\deepseek_ok_带市场情绪+指标版本.py
- 方式二：直接用虚拟环境的 Python 运行
  - venv\Scripts\python.exe .\deepseek_ok_带市场情绪+指标版本.py

以上即为在你的服务器环境上的推荐部署方案与完整操作步骤。如需我将情绪密钥改为 `.env` 读取并提交补丁，或提供标准化 Dockerfile 以加速启动，我可以继续完善。